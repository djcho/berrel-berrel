-- ShopGui: ìƒì  UI í´ë¼ì´ì–¸íŠ¸ ìŠ¤í¬ë¦½íŠ¸
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local screenGui = script.Parent

print("[ShopGui] ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘")

-- RemoteFunction/Event ì°¸ì¡°
print("[ShopGui] ShopSystem ëŒ€ê¸° ì¤‘...")
local ShopSystem = ReplicatedStorage:WaitForChild("ShopSystem", 30)
if not ShopSystem then
	warn("[ShopGui] ShopSystemì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
	return
end
print("[ShopGui] ShopSystem ì°¾ìŒ")

local UnlockBarrel = ShopSystem:WaitForChild("UnlockBarrel", 10)
local UpgradeBarrel = ShopSystem:WaitForChild("UpgradeBarrel", 10)
local GetPlayerShopData = ShopSystem:WaitForChild("GetPlayerShopData", 10)
print("[ShopGui] Remote Functions ì°¾ìŒ, OpenShopEvent ëŒ€ê¸° ì¤‘...")

-- OpenShopEventëŠ” ShopNpcServiceì—ì„œ ìƒì„±ë˜ë¯€ë¡œ ë” ê¸´ íƒ€ì„ì•„ì›ƒ ì‚¬ìš©
local OpenShopEvent = ShopSystem:WaitForChild("OpenShopEvent", 30)

if not OpenShopEvent then
	warn("[ShopGui] OpenShopEventë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
	return
end
print("[ShopGui] ëª¨ë“  RemoteEvent/Function ì°¾ìŒ")

-- ìƒ‰ìƒ ì„¤ì • (í•´ì  í…Œë§ˆ)
local COLORS = {
	woodDark = Color3.fromRGB(62, 39, 22),
	woodLight = Color3.fromRGB(90, 60, 35),
	gold = Color3.fromRGB(255, 200, 50),
	goldDark = Color3.fromRGB(180, 140, 30),
	red = Color3.fromRGB(180, 50, 50),
	green = Color3.fromRGB(50, 150, 80),
	blue = Color3.fromRGB(50, 100, 180),
	black = Color3.fromRGB(20, 15, 10),
	white = Color3.fromRGB(255, 255, 255),
	parchment = Color3.fromRGB(240, 220, 180),
	locked = Color3.fromRGB(100, 100, 100),
}

-- ì—…ê·¸ë ˆì´ë“œ íƒ€ì… í•œê¸€ëª…
local UPGRADE_NAMES = {
	Damage = "ë°ë¯¸ì§€",
	Range = "ì‚¬ê±°ë¦¬",
	Cooldown = "ì¬ì¥ì „",
	MaxShots = "ë³´ìœ ëŸ‰",
}

local shopData = nil
local currentGold = 0
local selectedBarrel = nil
local isOpen = false

-- ë©”ì¸ ì˜¤ë²„ë ˆì´ (ë°˜íˆ¬ëª… ë°°ê²½)
local overlay = Instance.new("Frame")
overlay.Name = "Overlay"
overlay.Size = UDim2.new(1, 0, 1, 0)
overlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
overlay.BackgroundTransparency = 0.5
overlay.Visible = false
overlay.ZIndex = 10
overlay.Parent = screenGui

-- ë©”ì¸ í”„ë ˆì„
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 700, 0, 500)
mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.BackgroundColor3 = COLORS.woodDark
mainFrame.ZIndex = 11
mainFrame.Parent = overlay

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 16)
mainCorner.Parent = mainFrame

local mainStroke = Instance.new("UIStroke")
mainStroke.Color = COLORS.gold
mainStroke.Thickness = 3
mainStroke.Parent = mainFrame

-- ìƒë‹¨ ë°” (íƒ€ì´í‹€)
local topBar = Instance.new("Frame")
topBar.Name = "TopBar"
topBar.Size = UDim2.new(1, 0, 0, 50)
topBar.BackgroundColor3 = COLORS.woodLight
topBar.ZIndex = 12
topBar.Parent = mainFrame

local topBarCorner = Instance.new("UICorner")
topBarCorner.CornerRadius = UDim.new(0, 16)
topBarCorner.Parent = topBar

local topBarFix = Instance.new("Frame")
topBarFix.Size = UDim2.new(1, 0, 0, 20)
topBarFix.Position = UDim2.new(0, 0, 1, -20)
topBarFix.BackgroundColor3 = COLORS.woodLight
topBarFix.BorderSizePixel = 0
topBarFix.ZIndex = 12
topBarFix.Parent = topBar

-- íƒ€ì´í‹€
local titleLabel = Instance.new("TextLabel")
titleLabel.Name = "Title"
titleLabel.Size = UDim2.new(0.6, 0, 1, 0)
titleLabel.Position = UDim2.new(0, 20, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "âš“ í†µ ìƒì "
titleLabel.TextColor3 = COLORS.gold
titleLabel.TextSize = 24
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.ZIndex = 13
titleLabel.Parent = topBar

-- ê³¨ë“œ í‘œì‹œ
local goldLabel = Instance.new("TextLabel")
goldLabel.Name = "GoldLabel"
goldLabel.Size = UDim2.new(0, 150, 0, 30)
goldLabel.Position = UDim2.new(1, -170, 0.5, -15)
goldLabel.BackgroundColor3 = COLORS.goldDark
goldLabel.TextColor3 = COLORS.white
goldLabel.Text = "ğŸª™ 0"
goldLabel.TextSize = 18
goldLabel.Font = Enum.Font.GothamBold
goldLabel.ZIndex = 13
goldLabel.Parent = topBar

local goldCorner = Instance.new("UICorner")
goldCorner.CornerRadius = UDim.new(0, 8)
goldCorner.Parent = goldLabel

-- ë‹«ê¸° ë²„íŠ¼
local closeButton = Instance.new("TextButton")
closeButton.Name = "CloseButton"
closeButton.Size = UDim2.new(0, 40, 0, 40)
closeButton.Position = UDim2.new(1, -45, 0.5, -20)
closeButton.BackgroundColor3 = COLORS.red
closeButton.Text = "X"
closeButton.TextColor3 = COLORS.white
closeButton.TextSize = 20
closeButton.Font = Enum.Font.GothamBold
closeButton.AutoButtonColor = false
closeButton.ZIndex = 13
closeButton.Parent = topBar

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 8)
closeCorner.Parent = closeButton

-- ì™¼ìª½ íŒ¨ë„ (í†µ ëª©ë¡)
local leftPanel = Instance.new("Frame")
leftPanel.Name = "LeftPanel"
leftPanel.Size = UDim2.new(0, 200, 1, -60)
leftPanel.Position = UDim2.new(0, 10, 0, 55)
leftPanel.BackgroundColor3 = COLORS.woodLight
leftPanel.BackgroundTransparency = 0.3
leftPanel.ZIndex = 12
leftPanel.Parent = mainFrame

local leftCorner = Instance.new("UICorner")
leftCorner.CornerRadius = UDim.new(0, 10)
leftCorner.Parent = leftPanel

-- í†µ ëª©ë¡ ìŠ¤í¬ë¡¤ í”„ë ˆì„
local barrelList = Instance.new("ScrollingFrame")
barrelList.Name = "BarrelList"
barrelList.Size = UDim2.new(1, -10, 1, -10)
barrelList.Position = UDim2.new(0, 5, 0, 5)
barrelList.BackgroundTransparency = 1
barrelList.ScrollBarThickness = 6
barrelList.CanvasSize = UDim2.new(0, 0, 0, 0)
barrelList.ZIndex = 13
barrelList.Parent = leftPanel

local barrelListLayout = Instance.new("UIListLayout")
barrelListLayout.Padding = UDim.new(0, 5)
barrelListLayout.Parent = barrelList

-- ì˜¤ë¥¸ìª½ íŒ¨ë„ (ìƒì„¸ ì •ë³´)
local rightPanel = Instance.new("Frame")
rightPanel.Name = "RightPanel"
rightPanel.Size = UDim2.new(1, -230, 1, -60)
rightPanel.Position = UDim2.new(0, 220, 0, 55)
rightPanel.BackgroundColor3 = COLORS.woodLight
rightPanel.BackgroundTransparency = 0.3
rightPanel.ZIndex = 12
rightPanel.Parent = mainFrame

local rightCorner = Instance.new("UICorner")
rightCorner.CornerRadius = UDim.new(0, 10)
rightCorner.Parent = rightPanel

-- ìƒì„¸ ì •ë³´ ì»¨í…Œì´ë„ˆ
local detailContainer = Instance.new("Frame")
detailContainer.Name = "DetailContainer"
detailContainer.Size = UDim2.new(1, -20, 1, -20)
detailContainer.Position = UDim2.new(0, 10, 0, 10)
detailContainer.BackgroundTransparency = 1
detailContainer.ZIndex = 13
detailContainer.Parent = rightPanel

-- ì„ íƒëœ í†µ ì´ë¦„
local selectedBarrelLabel = Instance.new("TextLabel")
selectedBarrelLabel.Name = "SelectedBarrelLabel"
selectedBarrelLabel.Size = UDim2.new(1, 0, 0, 40)
selectedBarrelLabel.BackgroundTransparency = 1
selectedBarrelLabel.Text = "í†µì„ ì„ íƒí•˜ì„¸ìš”"
selectedBarrelLabel.TextColor3 = COLORS.gold
selectedBarrelLabel.TextSize = 22
selectedBarrelLabel.Font = Enum.Font.GothamBold
selectedBarrelLabel.ZIndex = 14
selectedBarrelLabel.Parent = detailContainer

-- í•´ê¸ˆ ë²„íŠ¼
local unlockButton = Instance.new("TextButton")
unlockButton.Name = "UnlockButton"
unlockButton.Size = UDim2.new(1, 0, 0, 45)
unlockButton.Position = UDim2.new(0, 0, 0, 45)
unlockButton.BackgroundColor3 = COLORS.green
unlockButton.Text = "í•´ê¸ˆí•˜ê¸° (0G)"
unlockButton.TextColor3 = COLORS.white
unlockButton.TextSize = 18
unlockButton.Font = Enum.Font.GothamBold
unlockButton.AutoButtonColor = false
unlockButton.Visible = false
unlockButton.ZIndex = 14
unlockButton.Parent = detailContainer

local unlockCorner = Instance.new("UICorner")
unlockCorner.CornerRadius = UDim.new(0, 10)
unlockCorner.Parent = unlockButton

-- ìŠ¤íƒ¯ í‘œì‹œ ì˜ì—­
local statsFrame = Instance.new("Frame")
statsFrame.Name = "StatsFrame"
statsFrame.Size = UDim2.new(1, 0, 0, 80)
statsFrame.Position = UDim2.new(0, 0, 0, 50)
statsFrame.BackgroundTransparency = 1
statsFrame.Visible = false
statsFrame.ZIndex = 14
statsFrame.Parent = detailContainer

-- ì—…ê·¸ë ˆì´ë“œ ì˜ì—­
local upgradeFrame = Instance.new("Frame")
upgradeFrame.Name = "UpgradeFrame"
upgradeFrame.Size = UDim2.new(1, 0, 0, 250)
upgradeFrame.Position = UDim2.new(0, 0, 0, 135)
upgradeFrame.BackgroundTransparency = 1
upgradeFrame.Visible = false
upgradeFrame.ZIndex = 14
upgradeFrame.Parent = detailContainer

local upgradeLayout = Instance.new("UIListLayout")
upgradeLayout.Padding = UDim.new(0, 8)
upgradeLayout.Parent = upgradeFrame

-- ë©”ì‹œì§€ ë¼ë²¨ (êµ¬ë§¤ ê²°ê³¼ ë“±)
local messageLabel = Instance.new("TextLabel")
messageLabel.Name = "MessageLabel"
messageLabel.Size = UDim2.new(1, 0, 0, 30)
messageLabel.Position = UDim2.new(0, 0, 1, -35)
messageLabel.BackgroundTransparency = 1
messageLabel.Text = ""
messageLabel.TextColor3 = COLORS.gold
messageLabel.TextSize = 16
messageLabel.Font = Enum.Font.Gotham
messageLabel.ZIndex = 14
messageLabel.Parent = detailContainer

-- í†µ ì•„ì´í…œ ë²„íŠ¼ ìƒì„± í•¨ìˆ˜
local function createBarrelButton(barrelName, data)
	local button = Instance.new("TextButton")
	button.Name = barrelName
	button.Size = UDim2.new(1, -10, 0, 60)
	button.BackgroundColor3 = data.isUnlocked and COLORS.woodDark or COLORS.locked
	button.AutoButtonColor = false
	button.Text = ""
	button.ZIndex = 14
	button.Parent = barrelList

	local buttonCorner = Instance.new("UICorner")
	buttonCorner.CornerRadius = UDim.new(0, 8)
	buttonCorner.Parent = button

	local buttonStroke = Instance.new("UIStroke")
	buttonStroke.Color = data.isUnlocked and COLORS.gold or COLORS.locked
	buttonStroke.Thickness = 2
	buttonStroke.Parent = button

	-- ì•„ì´ì½˜
	local icon = Instance.new("ImageLabel")
	icon.Size = UDim2.new(0, 50, 0, 50)
	icon.Position = UDim2.new(0, 5, 0.5, -25)
	icon.BackgroundTransparency = 1
	icon.Image = data.iconId
	icon.ZIndex = 15
	icon.Parent = button

	-- ì´ë¦„
	local nameLabel = Instance.new("TextLabel")
	nameLabel.Name = "NameLabel"
	nameLabel.Size = UDim2.new(1, -60, 0, 25)
	nameLabel.Position = UDim2.new(0, 60, 0, 5)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Text = data.displayName
	nameLabel.TextColor3 = data.isUnlocked and COLORS.white or COLORS.locked
	nameLabel.TextSize = 14
	nameLabel.Font = Enum.Font.GothamBold
	nameLabel.TextXAlignment = Enum.TextXAlignment.Left
	nameLabel.ZIndex = 15
	nameLabel.Parent = button

	-- ìƒíƒœ
	local statusLabel = Instance.new("TextLabel")
	statusLabel.Name = "StatusLabel"
	statusLabel.Size = UDim2.new(1, -60, 0, 20)
	statusLabel.Position = UDim2.new(0, 60, 0, 30)
	statusLabel.BackgroundTransparency = 1
	statusLabel.Text = data.isUnlocked and "í•´ê¸ˆë¨" or (data.unlockPrice .. "G")
	statusLabel.TextColor3 = data.isUnlocked and COLORS.green or COLORS.goldDark
	statusLabel.TextSize = 12
	statusLabel.Font = Enum.Font.Gotham
	statusLabel.TextXAlignment = Enum.TextXAlignment.Left
	statusLabel.ZIndex = 15
	statusLabel.Parent = button

	-- í´ë¦­ ì´ë²¤íŠ¸
	button.MouseButton1Click:Connect(function()
		selectBarrel(barrelName)
	end)

	-- í˜¸ë²„ íš¨ê³¼ (ì„ íƒëœ ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ)
	button.MouseEnter:Connect(function()
		if selectedBarrel ~= barrelName then
			TweenService:Create(button, TweenInfo.new(0.15), {
				BackgroundColor3 = COLORS.woodLight
			}):Play()
		end
	end)

	button.MouseLeave:Connect(function()
		if selectedBarrel ~= barrelName then
			TweenService:Create(button, TweenInfo.new(0.15), {
				BackgroundColor3 = data.isUnlocked and COLORS.woodDark or COLORS.locked
			}):Play()
		end
	end)

	return button
end

-- ì—…ê·¸ë ˆì´ë“œ í–‰ ìƒì„± í•¨ìˆ˜
local function createUpgradeRow(upgradeType, currentLevel, maxLevel, nextPrice, barrelName)
	local row = Instance.new("Frame")
	row.Name = upgradeType
	row.Size = UDim2.new(1, 0, 0, 50)
	row.BackgroundColor3 = COLORS.woodDark
	row.ZIndex = 15
	row.Parent = upgradeFrame

	local rowCorner = Instance.new("UICorner")
	rowCorner.CornerRadius = UDim.new(0, 8)
	rowCorner.Parent = row

	-- ì—…ê·¸ë ˆì´ë“œ ì´ë¦„
	local nameLabel = Instance.new("TextLabel")
	nameLabel.Size = UDim2.new(0, 100, 1, 0)
	nameLabel.Position = UDim2.new(0, 10, 0, 0)
	nameLabel.BackgroundTransparency = 1
	nameLabel.Text = UPGRADE_NAMES[upgradeType] or upgradeType
	nameLabel.TextColor3 = COLORS.white
	nameLabel.TextSize = 14
	nameLabel.Font = Enum.Font.GothamBold
	nameLabel.TextXAlignment = Enum.TextXAlignment.Left
	nameLabel.ZIndex = 16
	nameLabel.Parent = row

	-- ë ˆë²¨ í‘œì‹œ
	local levelLabel = Instance.new("TextLabel")
	levelLabel.Size = UDim2.new(0, 80, 1, 0)
	levelLabel.Position = UDim2.new(0, 110, 0, 0)
	levelLabel.BackgroundTransparency = 1
	levelLabel.Text = "Lv." .. currentLevel .. "/" .. maxLevel
	levelLabel.TextColor3 = currentLevel >= maxLevel and COLORS.gold or COLORS.parchment
	levelLabel.TextSize = 14
	levelLabel.Font = Enum.Font.Gotham
	levelLabel.ZIndex = 16
	levelLabel.Parent = row

	-- ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼
	local upgradeBtn = Instance.new("TextButton")
	upgradeBtn.Size = UDim2.new(0, 100, 0, 35)
	upgradeBtn.Position = UDim2.new(1, -110, 0.5, -17.5)
	upgradeBtn.BackgroundColor3 = currentLevel >= maxLevel and COLORS.locked or COLORS.green
	upgradeBtn.Text = currentLevel >= maxLevel and "MAX" or (nextPrice .. "G")
	upgradeBtn.TextColor3 = COLORS.white
	upgradeBtn.TextSize = 14
	upgradeBtn.Font = Enum.Font.GothamBold
	upgradeBtn.AutoButtonColor = false
	upgradeBtn.ZIndex = 16
	upgradeBtn.Parent = row

	local btnCorner = Instance.new("UICorner")
	btnCorner.CornerRadius = UDim.new(0, 6)
	btnCorner.Parent = upgradeBtn

	if currentLevel < maxLevel then
		upgradeBtn.MouseButton1Click:Connect(function()
			local result = UpgradeBarrel:InvokeServer(barrelName, upgradeType)
			showMessage(result.message, result.success)
			if result.success then
				refreshShopData()
			end
		end)

		upgradeBtn.MouseEnter:Connect(function()
			TweenService:Create(upgradeBtn, TweenInfo.new(0.15), {
				BackgroundColor3 = Color3.fromRGB(40, 120, 60)
			}):Play()
		end)

		upgradeBtn.MouseLeave:Connect(function()
			TweenService:Create(upgradeBtn, TweenInfo.new(0.15), {
				BackgroundColor3 = COLORS.green
			}):Play()
		end)
	end

	return row
end

-- ìŠ¤íƒ¯ í‘œì‹œ ì—…ë°ì´íŠ¸
local function updateStatsDisplay(barrelName)
	-- ê¸°ì¡´ ìŠ¤íƒ¯ ë¼ë²¨ ì œê±°
	for _, child in ipairs(statsFrame:GetChildren()) do
		child:Destroy()
	end

	local data = shopData.barrels[barrelName]
	if not data or not data.currentStats then return end

	local stats = data.currentStats
	local statsText = string.format(
		"ë°ë¯¸ì§€: %d  |  ì‚¬ê±°ë¦¬: %d  |  ì¬ì¥ì „: %.1fì´ˆ  |  ë³´ìœ ëŸ‰: %d",
		stats.Damage, stats.MaxRange, stats.ReloadTime, stats.MaxShots
	)

	local statsLabel = Instance.new("TextLabel")
	statsLabel.Size = UDim2.new(1, 0, 1, 0)
	statsLabel.BackgroundColor3 = COLORS.woodDark
	statsLabel.Text = statsText
	statsLabel.TextColor3 = COLORS.parchment
	statsLabel.TextSize = 14
	statsLabel.Font = Enum.Font.Gotham
	statsLabel.TextWrapped = true
	statsLabel.ZIndex = 15
	statsLabel.Parent = statsFrame

	local statsCorner = Instance.new("UICorner")
	statsCorner.CornerRadius = UDim.new(0, 8)
	statsCorner.Parent = statsLabel
end

-- ì—…ê·¸ë ˆì´ë“œ ì˜ì—­ ì—…ë°ì´íŠ¸
local function updateUpgradeDisplay(barrelName)
	-- ê¸°ì¡´ ì—…ê·¸ë ˆì´ë“œ í–‰ ì œê±°
	for _, child in ipairs(upgradeFrame:GetChildren()) do
		if child:IsA("Frame") then
			child:Destroy()
		end
	end

	local data = shopData.barrels[barrelName]
	if not data then return end

	local upgradeConfig = shopData.upgradeConfig

	for upgradeType, config in pairs(upgradeConfig) do
		local currentLevel = data.upgrades[upgradeType] or 0
		local maxLevel, prices

		-- MaxShotsëŠ” ë°°ëŸ´ë³„ ì„¤ì • ì‚¬ìš©
		if upgradeType == "MaxShots" and config.perBarrel then
			local perBarrelConfig = config.perBarrel[barrelName]
			if perBarrelConfig then
				maxLevel = perBarrelConfig.maxLevel
				prices = perBarrelConfig.prices
			else
				maxLevel = 0
				prices = {}
			end
		else
			maxLevel = config.maxLevel
			prices = config.prices
		end

		local nextPrice = currentLevel < maxLevel and prices[currentLevel + 1] or 0
		createUpgradeRow(upgradeType, currentLevel, maxLevel, nextPrice, barrelName)
	end
end

-- ì„ íƒëœ í†µ ë²„íŠ¼ ê°•ì¡° ì—…ë°ì´íŠ¸
local function updateBarrelButtonSelection()
	for _, child in ipairs(barrelList:GetChildren()) do
		if child:IsA("TextButton") then
			local isSelected = child.Name == selectedBarrel
			local data = shopData and shopData.barrels[child.Name]
			local stroke = child:FindFirstChildOfClass("UIStroke")

			if isSelected then
				-- ì„ íƒëœ í†µ: ë°ì€ ë°°ê²½ + ë‘êº¼ìš´ ê³¨ë“œ í…Œë‘ë¦¬
				child.BackgroundColor3 = COLORS.gold
				if stroke then
					stroke.Color = COLORS.white
					stroke.Thickness = 3
				end
				-- í…ìŠ¤íŠ¸ ìƒ‰ìƒë„ ë³€ê²½
				for _, label in ipairs(child:GetChildren()) do
					if label:IsA("TextLabel") and label.Name ~= "StatusLabel" then
						label.TextColor3 = COLORS.black
					end
				end
			else
				-- ì„ íƒë˜ì§€ ì•Šì€ í†µ: ì›ë˜ ìƒ‰ìƒìœ¼ë¡œ ë³µì›
				local isUnlocked = data and data.isUnlocked
				child.BackgroundColor3 = isUnlocked and COLORS.woodDark or COLORS.locked
				if stroke then
					stroke.Color = isUnlocked and COLORS.gold or COLORS.locked
					stroke.Thickness = 2
				end
				-- í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³µì›
				for _, label in ipairs(child:GetChildren()) do
					if label:IsA("TextLabel") then
						if label.Name == "NameLabel" then
							label.TextColor3 = isUnlocked and COLORS.white or COLORS.locked
						end
					end
				end
			end
		end
	end
end

-- í†µ ì„ íƒ
function selectBarrel(barrelName)
	selectedBarrel = barrelName
	local data = shopData.barrels[barrelName]

	if not data then return end

	-- ì„ íƒ ìƒíƒœ ì‹œê°ì  ì—…ë°ì´íŠ¸
	updateBarrelButtonSelection()

	selectedBarrelLabel.Text = data.displayName

	if data.isUnlocked then
		unlockButton.Visible = false
		statsFrame.Visible = true
		statsFrame.Position = UDim2.new(0, 0, 0, 45)
		upgradeFrame.Visible = true
		upgradeFrame.Position = UDim2.new(0, 0, 0, 130)

		updateStatsDisplay(barrelName)
		updateUpgradeDisplay(barrelName)
	else
		unlockButton.Visible = true
		unlockButton.Text = "í•´ê¸ˆí•˜ê¸° (" .. data.unlockPrice .. "G)"
		statsFrame.Visible = false
		upgradeFrame.Visible = false
	end
end

-- ë©”ì‹œì§€ í‘œì‹œ
function showMessage(msg, success)
	messageLabel.Text = msg
	messageLabel.TextColor3 = success and COLORS.green or COLORS.red

	-- 3ì´ˆ í›„ ë©”ì‹œì§€ ì‚¬ë¼ì§
	task.delay(3, function()
		if messageLabel.Text == msg then
			messageLabel.Text = ""
		end
	end)
end

-- ìƒì  ë°ì´í„° ìƒˆë¡œê³ ì¹¨
function refreshShopData()
	local result = GetPlayerShopData:InvokeServer()
	if result then
		currentGold = result.gold
		shopData = result.shopData
		goldLabel.Text = "ğŸª™ " .. currentGold

		-- í†µ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
		for _, child in ipairs(barrelList:GetChildren()) do
			if child:IsA("TextButton") then
				child:Destroy()
			end
		end

		for barrelName, data in pairs(shopData.barrels) do
			createBarrelButton(barrelName, data)
		end

		-- ìº”ë²„ìŠ¤ í¬ê¸° ì—…ë°ì´íŠ¸
		barrelList.CanvasSize = UDim2.new(0, 0, 0, barrelListLayout.AbsoluteContentSize.Y + 10)

		-- ì„ íƒëœ í†µ ë‹¤ì‹œ í‘œì‹œ
		if selectedBarrel then
			selectBarrel(selectedBarrel)
		end
	end
end

-- ìƒì  ì—´ê¸°
local function openShop()
	if isOpen then return end
	isOpen = true

	refreshShopData()

	-- ê¸°ë³¸ í†µ ì„ íƒ (selectedBarrelì´ ì—†ìœ¼ë©´ NormalBarrel ì„ íƒ)
	if not selectedBarrel and shopData and shopData.barrels then
		if shopData.barrels["NormalBarrel"] then
			selectBarrel("NormalBarrel")
		else
			-- NormalBarrelì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ í†µ ì„ íƒ
			for barrelName, _ in pairs(shopData.barrels) do
				selectBarrel(barrelName)
				break
			end
		end
	end

	overlay.Visible = true
	mainFrame.Size = UDim2.new(0, 0, 0, 0)

	TweenService:Create(mainFrame, TweenInfo.new(0.2, Enum.EasingStyle.Back), {
		Size = UDim2.new(0, 700, 0, 500)
	}):Play()
end

-- ìƒì  ë‹«ê¸°
local function closeShop()
	if not isOpen then return end

	local tween = TweenService:Create(mainFrame, TweenInfo.new(0.15), {
		Size = UDim2.new(0, 0, 0, 0)
	})
	tween:Play()
	tween.Completed:Wait()

	overlay.Visible = false
	isOpen = false
	selectedBarrel = nil
end

-- ì´ë²¤íŠ¸ ì—°ê²°
closeButton.MouseButton1Click:Connect(closeShop)

closeButton.MouseEnter:Connect(function()
	TweenService:Create(closeButton, TweenInfo.new(0.15), {
		BackgroundColor3 = Color3.fromRGB(120, 30, 30)
	}):Play()
end)

closeButton.MouseLeave:Connect(function()
	TweenService:Create(closeButton, TweenInfo.new(0.15), {
		BackgroundColor3 = COLORS.red
	}):Play()
end)

-- í•´ê¸ˆ ë²„íŠ¼ í´ë¦­
unlockButton.MouseButton1Click:Connect(function()
	if not selectedBarrel then return end

	local result = UnlockBarrel:InvokeServer(selectedBarrel)
	showMessage(result.message, result.success)
	if result.success then
		refreshShopData()
	end
end)

unlockButton.MouseEnter:Connect(function()
	TweenService:Create(unlockButton, TweenInfo.new(0.15), {
		BackgroundColor3 = Color3.fromRGB(40, 120, 60)
	}):Play()
end)

unlockButton.MouseLeave:Connect(function()
	TweenService:Create(unlockButton, TweenInfo.new(0.15), {
		BackgroundColor3 = COLORS.green
	}):Play()
end)

-- ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
overlay.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		local mousePos = input.Position
		local framePos = mainFrame.AbsolutePosition
		local frameSize = mainFrame.AbsoluteSize

		if mousePos.X < framePos.X or mousePos.X > framePos.X + frameSize.X or
		   mousePos.Y < framePos.Y or mousePos.Y > framePos.Y + frameSize.Y then
			closeShop()
		end
	end
end)

-- ì„œë²„ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
OpenShopEvent.OnClientEvent:Connect(function()
	print("[ShopGui] OpenShopEvent ìˆ˜ì‹ ë¨!")
	openShop()
end)

-- ê³¨ë“œ ë³€ê²½ ê°ì§€ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
local leaderstats = player:WaitForChild("leaderstats")
local coins = leaderstats:WaitForChild("Coins")
coins.Changed:Connect(function(newValue)
	currentGold = newValue
	goldLabel.Text = "ğŸª™ " .. currentGold
end)

print("[ShopGui] ì´ˆê¸°í™” ì™„ë£Œ")
