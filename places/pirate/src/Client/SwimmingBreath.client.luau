-- SwimmingBreath: μ μ μ‹ νΈν΅ κ²μ΄μ§€ λ° μµμ‚¬ μ‹μ¤ν…
-- μλ©΄ μ„μ—μ„λ” νΈν΅ νλ³µ, μλ©΄ μ•„λ(μ μ)μ—μ„λ” νΈν΅ κ°μ† ν›„ μµμ‚¬

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer

-- μ„¤μ •
local CONFIG = {
	MAX_BREATH = 100,           -- μµλ€ νΈν΅ κ²μ΄μ§€
	BREATH_DECREASE_RATE = 20,  -- μ΄λ‹Ή νΈν΅ κ°μ†λ‰ (μ μ μ‹) - 5μ΄λ©΄ λ°”λ‹¥
	BREATH_INCREASE_RATE = 25,  -- μ΄λ‹Ή νΈν΅ νλ³µλ‰ (μλ©΄ μ„)
	DROWN_DAMAGE = 10,          -- μµμ‚¬ μ‹ μ΄λ‹Ή λ°λ―Έμ§€
}

-- μƒνƒ λ³€μ
local currentBreath = CONFIG.MAX_BREATH
local isUnderwater = false
local isSwimming = false
local breathGui = nil
local breathBar = nil
local drowningEvent = nil

-- μµμ‚¬ λ°λ―Έμ§€ RemoteEvent κ°€μ Έμ¤κΈ° λλ” μƒμ„±
local function getDrowningEvent()
	if drowningEvent then return drowningEvent end

	drowningEvent = ReplicatedStorage:FindFirstChild("DrowningDamageEvent")
	return drowningEvent
end

-- ν”λ μ΄μ–΄κ°€ μμ μ¤‘μΈμ§€ ν™•μΈ (Humanoid μƒνƒ)
local function checkIfSwimming()
	local character = player.Character
	if not character then return false end

	local humanoid = character:FindFirstChild("Humanoid")
	if not humanoid then return false end

	return humanoid:GetState() == Enum.HumanoidStateType.Swimming
end

-- ν”λ μ΄μ–΄κ°€ μλ©΄ μ•„λ(μ μ)μ— μλ”μ§€ ν™•μΈ
-- λ¨Έλ¦¬ μ„μ— λ¬Όμ΄ μμΌλ©΄ μ μ μƒνƒ
local function checkIfUnderwater()
	local character = player.Character
	if not character then return false end

	local head = character:FindFirstChild("Head")
	if not head then return false end

	-- μμ μƒνƒκ°€ μ•„λ‹λ©΄ μ μ μ•„λ‹
	if not isSwimming then
		return false
	end

	-- λ¨Έλ¦¬ λ°”λ΅ μ„(0.5 μ¤ν„°λ“)μ— λ¬Όμ΄ μλ”μ§€ ν™•μΈ
	local checkPosition = head.Position + Vector3.new(0, 0.5, 0)

	local terrain = workspace:FindFirstChildOfClass("Terrain")
	if terrain then
		local region = Region3.new(
			checkPosition - Vector3.new(0.5, 0.5, 0.5),
			checkPosition + Vector3.new(0.5, 0.5, 0.5)
		):ExpandToGrid(4)

		local materials, occupancies = terrain:ReadVoxels(region, 4)

		-- λ¨Έλ¦¬ μ„μ— λ¬Όμ΄ μμΌλ©΄ μ μ μƒνƒ
		for x = 1, materials.Size.X do
			for y = 1, materials.Size.Y do
				for z = 1, materials.Size.Z do
					if materials[x][y][z] == Enum.Material.Water and occupancies[x][y][z] > 0.1 then
						return true
					end
				end
			end
		end
	end

	-- λ¨Έλ¦¬ μ„μ— λ¬Όμ΄ μ—†μΌλ©΄ μλ©΄ μ„
	return false
end

-- νΈν΅ κ²μ΄μ§€ UI μƒμ„±
local function createBreathGui()
	local screenGui = Instance.new("ScreenGui")
	screenGui.Name = "BreathGui"
	screenGui.ResetOnSpawn = true
	screenGui.Parent = player.PlayerGui

	-- νΈν΅ κ²μ΄μ§€ λ°°κ²½ ν”„λ μ„ (ν—¬μ¤λ°” μ„μ— λ°°μΉ, κ°„κ²© μκ²)
	-- ν—¬μ¤λ°”: Position(0.5, 0, 0.844, 0), Size(0.331, 0, 0.027, 0)
	local breathFrame = Instance.new("Frame")
	breathFrame.Name = "BreathFrame"
	breathFrame.Size = UDim2.new(0, 200, 0, 12)  -- μ›λ ν¬κΈ°
	breathFrame.Position = UDim2.new(0.5, 0, 0.8, 0)  -- ν—¬μ¤λ°” μ„μ— κ°„κ²© λ‘κ³ 
	breathFrame.AnchorPoint = Vector2.new(0.5, 0.5)
	breathFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
	breathFrame.BorderSizePixel = 0
	breathFrame.Visible = false
	breathFrame.Parent = screenGui

	local frameCorner = Instance.new("UICorner")
	frameCorner.CornerRadius = UDim.new(0, 6)
	frameCorner.Parent = breathFrame

	local frameStroke = Instance.new("UIStroke")
	frameStroke.Color = Color3.fromRGB(80, 80, 80)
	frameStroke.Thickness = 2
	frameStroke.Parent = breathFrame

	-- νΈν΅ κ²μ΄μ§€ λ°”
	local bar = Instance.new("Frame")
	bar.Name = "BreathBar"
	bar.Size = UDim2.new(1, -4, 1, -4)
	bar.Position = UDim2.new(0, 2, 0, 2)
	bar.BackgroundColor3 = Color3.fromRGB(100, 180, 255)
	bar.BorderSizePixel = 0
	bar.Parent = breathFrame

	local barCorner = Instance.new("UICorner")
	barCorner.CornerRadius = UDim.new(0, 4)
	barCorner.Parent = bar

	-- μ•„μ΄μ½ (λ¬Όλ°©μΈ)
	local icon = Instance.new("TextLabel")
	icon.Name = "Icon"
	icon.Size = UDim2.new(0, 20, 0, 20)
	icon.Position = UDim2.new(0, -24, 0.5, -10)
	icon.BackgroundTransparency = 1
	icon.Text = "π’§"
	icon.TextSize = 14
	icon.Parent = breathFrame

	breathGui = screenGui
	breathBar = bar

	return screenGui, bar
end

-- νΈν΅ κ²μ΄μ§€ μ—…λ°μ΄νΈ
local function updateBreathGui()
	if not breathGui then
		createBreathGui()
	end

	local breathFrame = breathGui:FindFirstChild("BreathFrame")
	if not breathFrame then return end

	-- μμ μ¤‘μ΄κ±°λ‚, μ μ μ¤‘μ΄κ±°λ‚, νΈν΅μ΄ κ°€λ“ μ°¨μ§€ μ•μ€ κ²½μ° ν‘μ‹
	local shouldShow = isSwimming or isUnderwater or currentBreath < CONFIG.MAX_BREATH
	breathFrame.Visible = shouldShow

	if shouldShow then
		local breathPercent = currentBreath / CONFIG.MAX_BREATH
		breathBar.Size = UDim2.new(breathPercent, -4, 1, -4)

		-- νΈν΅μ— λ”°λΌ μƒ‰μƒ λ³€κ²½
		if breathPercent > 0.5 then
			breathBar.BackgroundColor3 = Color3.fromRGB(100, 180, 255)  -- νλ€μƒ‰
		elseif breathPercent > 0.25 then
			breathBar.BackgroundColor3 = Color3.fromRGB(255, 200, 50)   -- λ…Έλ€μƒ‰
		else
			breathBar.BackgroundColor3 = Color3.fromRGB(255, 80, 80)    -- λΉ¨κ°„μƒ‰
		end
	end
end

-- μµμ‚¬ λ°λ―Έμ§€ μ²λ¦¬ (μ„λ²„μ— μ”μ²­)
local function requestDrowningDamage()
	local event = getDrowningEvent()
	if event then
		event:FireServer(CONFIG.DROWN_DAMAGE)
	end
end

-- λ©”μΈ λ£¨ν”„
local lastUpdate = tick()
RunService.Heartbeat:Connect(function()
	local character = player.Character
	if not character then return end

	local humanoid = character:FindFirstChild("Humanoid")
	if not humanoid or humanoid.Health <= 0 then
		-- μ£½μΌλ©΄ νΈν΅ λ¦¬μ…‹
		currentBreath = CONFIG.MAX_BREATH
		isUnderwater = false
		isSwimming = false
		updateBreathGui()
		return
	end

	local now = tick()
	local deltaTime = now - lastUpdate
	lastUpdate = now

	-- μμ μƒνƒ λ° μ μ μƒνƒ μ²΄ν¬
	isSwimming = checkIfSwimming()
	isUnderwater = checkIfUnderwater()

	-- μ μ μ¤‘ (λ¨Έλ¦¬κ°€ λ¬Όμ†)μΌ λ•λ§ νΈν΅ κ°μ†
	if isUnderwater then
		-- μ μ μ¤‘: νΈν΅ κ°μ†
		currentBreath = math.max(0, currentBreath - CONFIG.BREATH_DECREASE_RATE * deltaTime)

		-- νΈν΅μ΄ 0μ΄λ©΄ μµμ‚¬ λ°λ―Έμ§€
		if currentBreath <= 0 then
			requestDrowningDamage()
		end
	elseif isSwimming then
		-- μμ μ¤‘μ΄μ§€λ§ μλ©΄ μ„: νΈν΅ μ„μ„ν νλ³µ
		currentBreath = math.min(CONFIG.MAX_BREATH, currentBreath + CONFIG.BREATH_INCREASE_RATE * deltaTime)
	else
		-- λ¬Ό λ°–: λΉ λ¥΄κ² νλ³µ
		currentBreath = math.min(CONFIG.MAX_BREATH, currentBreath + CONFIG.BREATH_INCREASE_RATE * 2 * deltaTime)
	end

	updateBreathGui()
end)

-- μΊλ¦­ν„° λ¦¬μ¤ν° μ‹ νΈν΅ λ¦¬μ…‹
player.CharacterAdded:Connect(function()
	currentBreath = CONFIG.MAX_BREATH
	isUnderwater = false

	-- κΈ°μ΅΄ GUI μ κ±° (μƒλ΅ μƒμ„±λ¨)
	if breathGui then
		breathGui:Destroy()
		breathGui = nil
		breathBar = nil
	end
end)
